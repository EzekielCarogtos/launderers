<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home"></ion-back-button>
    </ion-buttons>
    <ion-title>My Orders</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="orders-content">
  <!-- Loading State -->
  <div class="loading-state" *ngIf="isLoading">
    <div class="spinner-container">
      <ion-spinner name="crescent"></ion-spinner>
      <p>Loading your orders...</p>
    </div>
  </div>

  <!-- Orders Content -->
  <div *ngIf="!isLoading">
    <!-- Filter Segment -->
    <div class="filter-section">
      <ion-segment [value]="selectedFilter" (ionChange)="onFilterChange($event)">
        <ion-segment-button *ngFor="let filter of filterOptions" [value]="filter.value">
          <ion-label>{{ filter.label }}</ion-label>
        </ion-segment-button>
      </ion-segment>
    </div>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="filteredOrders.length === 0">
      <div class="empty-icon">
        <ion-icon name="receipt-outline"></ion-icon>
      </div>
      <h3>No orders found</h3>
      <p *ngIf="selectedFilter === 'all'">You haven't placed any orders yet.</p>
      <p *ngIf="selectedFilter !== 'all'">No {{selectedFilter}} orders found.</p>
      <ion-button fill="outline" (click)="goToServices()">
        <ion-icon name="shirt-outline" slot="start"></ion-icon>
        Browse Services
      </ion-button>
    </div>

    <!-- Orders List -->
    <div class="orders-list" *ngIf="filteredOrders.length > 0">
      <ion-refresher slot="fixed" (ionRefresh)="refreshOrders($event)">
        <ion-refresher-content></ion-refresher-content>
      </ion-refresher>

      <div class="orders-count">
        {{ filteredOrders.length }} order{{ filteredOrders.length !== 1 ? 's' : '' }} found
      </div>

      <ion-list lines="none">
        <ion-item *ngFor="let order of filteredOrders; trackBy: trackByOrderId" class="order-item">
          <div class="order-card">
            <!-- Order Header -->
            <div class="order-header">
              <div class="order-info">
                <h3 class="order-id">Order #{{ order.orderId.slice(-6).toUpperCase() }}</h3>
                <p class="order-date">{{ getOrderDate(order.createdAt) }}</p>
              </div>
              <ion-badge [color]="getStatusColor(order)" class="status-badge">
                {{ getOrderStatus(order) }}
              </ion-badge>
            </div>

            <!-- Order Details -->
            <div class="order-details">
              <div class="detail-row">
                <div class="detail-item">
                  <ion-icon name="time-outline"></ion-icon>
                  <span>{{ getTimeRemaining(order) }}</span>
                </div>
                <div class="detail-item">
                  <ion-icon [name]="getDeliveryTypeIcon(order)"></ion-icon>
                  <span>{{ getDeliveryTypeText(order) }}</span>
                </div>
                <div class="detail-item">
                  <ion-icon name="cube-outline"></ion-icon>
                  <span>{{ getItemsCount(order) }} item{{ getItemsCount(order) !== 1 ? 's' : '' }}</span>
                </div>
              </div>

              <!-- Delivery/Pickup Info -->
              <div class="delivery-info">
                <div class="info-row">
                  <strong>{{ order.type === 'delivery' ? 'Delivery to:' : 'Pickup at:' }}</strong>
                  <span>{{ order.address }}</span>
                </div>
                <div class="info-row">
                  <strong>Scheduled:</strong>
                  <span>{{ order.selectedDate }} at {{ order.selectedTime }}</span>
                </div>
              </div>

              <!-- Order Items Preview -->
              <div class="items-preview">
                <div class="preview-header">
                  <strong>Items:</strong>
                </div>
                <div class="preview-items">
                  <span *ngFor="let item of order.items.slice(0, 2); let last = last" class="preview-item">
                    {{ getCasualName(item.casual) }}{{ !last ? ',' : '' }}
                  </span>
                  <span *ngIf="order.items.length > 2" class="more-items">
                    +{{ order.items.length - 2 }} more
                  </span>
                </div>
              </div>

              <!-- Order Total -->
              <div class="order-total">
                <div class="total-label">Total Amount:</div>
                <div class="total-amount">₱{{ order.total }}.00</div>
              </div>

              <!-- Action Buttons -->
              <div class="action-buttons" *ngIf="order.status === 'ready' || order.status === 'processing'">
                <ion-button *ngIf="order.status === 'ready'" fill="solid" color="success" size="small">
                  <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
                  {{ order.type === 'delivery' ? 'Track Delivery' : 'Pick Up Now' }}
                </ion-button>
                
                <ion-button *ngIf="order.status === 'processing'" fill="outline" color="medium" size="small" disabled>
                  <ion-icon name="time-outline" slot="start"></ion-icon>
                  In Progress
                </ion-button>

                <ion-button *ngIf="canCancelOrder(order)" 
                           fill="outline" color="danger" size="small" (click)="cancelOrder(order)">
                  <ion-icon name="close-circle-outline" slot="start"></ion-icon>
                  Cancel
                </ion-button>
              </div>

              <!-- Completed/Cancelled Actions -->
              <div class="action-buttons" *ngIf="order.status === 'completed' || order.status === 'cancelled'">
                <ion-button fill="outline" color="primary" size="small" (click)="openOrderDetails(order)">
                  <ion-icon name="receipt-outline" slot="start"></ion-icon>
                  View Details
                </ion-button>
                <ion-button *ngIf="order.status === 'completed'" fill="outline" color="medium" size="small" (click)="reorderItems(order)">
                  <ion-icon name="repeat-outline" slot="start"></ion-icon>
                  Reorder
                </ion-button>
              </div>
            </div>
          </div>
        </ion-item>
      </ion-list>
    </div>
  </div>
</ion-content>

<!-- Order Details Modal -->
<ion-modal [isOpen]="isOrderDetailsOpen" (didDismiss)="closeOrderDetails()">
  <ng-template>
    <ion-header [translucent]="true">
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button (click)="closeOrderDetails()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Order Details</ion-title>
        <ion-buttons slot="end">
          <ion-button *ngIf="selectedOrder?.status === 'completed'" (click)="reorderItems(selectedOrder!)">
            <ion-icon name="repeat-outline" slot="start"></ion-icon>
            Reorder
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="order-details-modal" *ngIf="selectedOrder">
      <div class="order-summary">
        <!-- Order Header -->
        <div class="order-header-section">
          <h2>Order #{{ selectedOrder.orderId.slice(-6).toUpperCase() }}</h2>
          <ion-badge [color]="getStatusColor(selectedOrder)" class="status-badge-large">
            {{ getOrderStatus(selectedOrder) }}
          </ion-badge>
        </div>

        <p class="order-date">{{ getOrderDate(selectedOrder.createdAt) }}</p>

        <!-- Order Timeline -->
        <div class="timeline-section">
          <h3>Order Timeline</h3>
          <div class="timeline">
            <div class="timeline-item" [class.active]="isStatusActive(selectedOrder, 'pending')">
              <div class="timeline-dot"></div>
              <div class="timeline-content">
                <strong>Order Placed</strong>
                <span>{{ getOrderDate(selectedOrder.createdAt) }}</span>
              </div>
            </div>
            <div class="timeline-item" [class.active]="isStatusActive(selectedOrder, 'processing')">
              <div class="timeline-dot"></div>
              <div class="timeline-content">
                <strong>Processing</strong>
                <span *ngIf="selectedOrder.status === 'processing' || selectedOrder.status === 'ready' || selectedOrder.status === 'completed'">
                  {{ getProcessingDate(selectedOrder.createdAt) }}
                </span>
              </div>
            </div>
            <div class="timeline-item" [class.active]="isStatusActive(selectedOrder, 'ready')">
              <div class="timeline-dot"></div>
              <div class="timeline-content">
                <strong>Ready for {{ selectedOrder.type === 'delivery' ? 'Delivery' : 'Pickup' }}</strong>
                <span *ngIf="selectedOrder.status === 'ready' || selectedOrder.status === 'completed'">
                  {{ getReadyDate(selectedOrder.createdAt) }}
                </span>
              </div>
            </div>
            <div class="timeline-item" [class.active]="isStatusActive(selectedOrder, 'completed')">
              <div class="timeline-dot"></div>
              <div class="timeline-content">
                <strong>Completed</strong>
                <span *ngIf="selectedOrder.status === 'completed'">
                  {{ getCompletedDate(selectedOrder.createdAt) }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Delivery/Pickup Information -->
        <div class="delivery-section">
          <h3>{{ selectedOrder.type === 'delivery' ? 'Delivery Information' : 'Pickup Information' }}</h3>
          <div class="info-card">
            <div class="info-row">
              <ion-icon [name]="getDeliveryTypeIcon(selectedOrder)"></ion-icon>
              <div class="info-content">
                <strong>{{ selectedOrder.type === 'delivery' ? 'Delivery Address' : 'Pickup Location' }}</strong>
                <p>{{ selectedOrder.address }}</p>
              </div>
            </div>
            <div class="info-row">
              <ion-icon name="calendar-outline"></ion-icon>
              <div class="info-content">
                <strong>Scheduled Date & Time</strong>
                <p>{{ selectedOrder.selectedDate }} at {{ selectedOrder.selectedTime }}</p>
              </div>
            </div>
            <div class="info-row">
              <ion-icon name="card-outline"></ion-icon>
              <div class="info-content">
                <strong>Payment Method</strong>
                <p>{{ selectedOrder.payment === 'cash' ? 'Cash on Delivery' : 'GCash' }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Order Items -->
        <div class="items-section">
          <h3>Order Items ({{ getItemsCount(selectedOrder) }})</h3>
          <div class="items-list">
            <div *ngFor="let item of selectedOrder.items" class="item-detail">
              <div class="item-image-container">
                <img [src]="getItemImage(item)" class="item-image" />
              </div>
              <div class="item-info">
                <h4 class="item-name">{{ getCasualName(item.casual) }}</h4>
                <p class="item-details">
                  <span class="item-type">{{ getSegmentName(item.segment) }} Service</span>
                  <span class="item-weight">• {{ item.weight ? item.weight : '8KG or less' }}</span>
                  <span class="item-qty">• Qty: {{ item.qty || 1 }}</span>
                </p>
                <div class="item-additions" *ngIf="item.additionals.length > 0">
                  <strong>Add-ons:</strong> {{ item.additionals.join(', ') }}
                </div>
              </div>
              <div class="item-price">
                ₱{{ getItemPrice(item) * (item.qty || 1) }}.00
              </div>
            </div>
          </div>
        </div>

        <!-- Price Breakdown -->
        <div class="price-section">
          <h3>Price Breakdown</h3>
          <div class="price-breakdown">
            <div class="price-row">
              <span>Subtotal:</span>
              <span>₱{{ calculateSubtotal(selectedOrder) }}.00</span>
            </div>
            <div class="price-row">
              <span>Delivery Fee:</span>
              <span>{{ selectedOrder.type === 'delivery' ? '₱30.00' : '₱0.00' }}</span>
            </div>
            <div class="price-row total">
              <span><strong>Total:</strong></span>
              <span><strong>₱{{ selectedOrder.total }}.00</strong></span>
            </div>
          </div>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Reorder Success Toast -->
<ion-toast
  [isOpen]="showReorderSuccess"
  message="Items added to basket successfully!"
  [duration]="3000"
  (didDismiss)="showReorderSuccess = false"
  position="bottom"
  color="success">
</ion-toast>